version: '3.8'

services:
  # ==========================================
  # Traefik - Reverse Proxy & SSL
  # ==========================================
  traefik:
    image: traefik:v3.6.1
    restart: always
    command:
      - "--api.dashboard=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.web.http.redirections.entryPoint.to=websecure"
      - "--entrypoints.web.http.redirections.entryPoint.scheme=https"
      - "--entrypoints.websecure.address=:443"
      - "--certificatesresolvers.mytlschallenge.acme.tlschallenge=true"
      - "--certificatesresolvers.mytlschallenge.acme.email=${SSL_EMAIL}"
      - "--certificatesresolvers.mytlschallenge.acme.storage=/letsencrypt/acme.json"
      - "--ping=true"
      - "--log.level=INFO"
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - traefik_data:/letsencrypt
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks: [yojob-network]
    labels:
      - traefik.enable=true

      # Dashboard Traefik (traefik.yojob.fr) - optionnel
      - traefik.http.routers.traefik.rule=Host(`traefik.${DOMAIN_NAME}`)
      - traefik.http.routers.traefik.entrypoints=websecure
      - traefik.http.routers.traefik.tls=true
      - traefik.http.routers.traefik.tls.certresolver=mytlschallenge
      - traefik.http.routers.traefik.service=api@internal

      # Auth basic pour le dashboard (optionnel)
      # Générer avec : htpasswd -nb admin password | sed 's/\$/\$\$/g'
      - traefik.http.middlewares.traefik-auth.basicauth.users=${TRAEFIK_DASHBOARD_AUTH:-admin:$$2y$$05$$Example}
      - traefik.http.middlewares.traefik-auth.basicauth.removeheader=true

      # Security headers
      - traefik.http.middlewares.traefik-headers.headers.SSLRedirect=true
      - traefik.http.middlewares.traefik-headers.headers.STSSeconds=31536000
      - traefik.http.middlewares.traefik-headers.headers.browserXSSFilter=true
      - traefik.http.middlewares.traefik-headers.headers.contentTypeNosniff=true
      - traefik.http.middlewares.traefik-headers.headers.forceSTSHeader=true
      - traefik.http.middlewares.traefik-headers.headers.STSIncludeSubdomains=true
      - traefik.http.middlewares.traefik-headers.headers.STSPreload=true

      # Appliquer les middlewares au dashboard
      - traefik.http.routers.traefik.middlewares=traefik-auth@docker,traefik-headers@docker

      # Réseau Docker
      - traefik.docker.network=yojob-network

    healthcheck:
      test: ["CMD", "traefik", "healthcheck", "--ping"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ==========================================
  # Landing Page YOJOB (yojob.fr)
  # ==========================================
  yojob-landing:
    build:
      context: ./landing-page
      dockerfile: Dockerfile
      args:
        - NODE_ENV=production
        # Variables d'environnement Vite pour la landing page (décommenter si nécessaire)
        # - VITE_API_URL=${VITE_API_URL}
        # - VITE_GOOGLE_ANALYTICS_ID=${VITE_GOOGLE_ANALYTICS_ID}
    container_name: yojob-landing
    restart: always
    networks: [yojob-network]
    labels:
      - traefik.enable=true

      # Router principal (yojob.fr + www.yojob.fr)
      - traefik.http.routers.yojob-landing.rule=Host(`${DOMAIN_NAME}`) || Host(`www.${DOMAIN_NAME}`)
      - traefik.http.routers.yojob-landing.entrypoints=websecure
      - traefik.http.routers.yojob-landing.tls=true
      - traefik.http.routers.yojob-landing.tls.certresolver=mytlschallenge

      # Port du service (Nginx interne)
      - traefik.http.services.yojob-landing.loadbalancer.server.port=80

      # Redirection www → non-www (optionnel)
      - traefik.http.middlewares.yojob-redirect.redirectregex.regex=^https://www\\.${DOMAIN_NAME}/(.*)
      - traefik.http.middlewares.yojob-redirect.redirectregex.replacement=https://${DOMAIN_NAME}/$${1}

      # Security headers
      - traefik.http.middlewares.yojob-headers.headers.SSLRedirect=true
      - traefik.http.middlewares.yojob-headers.headers.STSSeconds=31536000
      - traefik.http.middlewares.yojob-headers.headers.browserXSSFilter=true
      - traefik.http.middlewares.yojob-headers.headers.contentTypeNosniff=true
      - traefik.http.middlewares.yojob-headers.headers.forceSTSHeader=true
      - traefik.http.middlewares.yojob-headers.headers.SSLHost=${DOMAIN_NAME}
      - traefik.http.middlewares.yojob-headers.headers.STSIncludeSubdomains=true
      - traefik.http.middlewares.yojob-headers.headers.STSPreload=true

      # Appliquer les middlewares
      - traefik.http.routers.yojob-landing.middlewares=yojob-redirect@docker,yojob-headers@docker

      # Réseau Docker
      - traefik.docker.network=yojob-network

    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ==========================================
  # Formulaire Étude (etude.yojob.fr)
  # ==========================================
  yojob-survey:
    build:
      context: ./survey-form
      dockerfile: Dockerfile
      args:
        - VITE_SUPABASE_PROJECT_ID=${SUPABASE_PROJECT_ID}
        - VITE_SUPABASE_ANON_KEY=${SUPABASE_ANON_KEY}
        - NODE_ENV=production
    container_name: yojob-survey
    restart: always
    networks: [yojob-network]
    labels:
      - traefik.enable=true

      # Router pour le sous-domaine etude
      - traefik.http.routers.yojob-survey.rule=Host(`etude.${DOMAIN_NAME}`)
      - traefik.http.routers.yojob-survey.entrypoints=websecure
      - traefik.http.routers.yojob-survey.tls=true
      - traefik.http.routers.yojob-survey.tls.certresolver=mytlschallenge

      # Port du service (Nginx interne)
      - traefik.http.services.yojob-survey.loadbalancer.server.port=80

      # Security headers
      - traefik.http.middlewares.yojob-survey-headers.headers.SSLRedirect=true
      - traefik.http.middlewares.yojob-survey-headers.headers.STSSeconds=31536000
      - traefik.http.middlewares.yojob-survey-headers.headers.browserXSSFilter=true
      - traefik.http.middlewares.yojob-survey-headers.headers.contentTypeNosniff=true
      - traefik.http.middlewares.yojob-survey-headers.headers.forceSTSHeader=true
      - traefik.http.middlewares.yojob-survey-headers.headers.SSLHost=etude.${DOMAIN_NAME}
      - traefik.http.middlewares.yojob-survey-headers.headers.STSIncludeSubdomains=true
      - traefik.http.middlewares.yojob-survey-headers.headers.STSPreload=true

      # Appliquer les middlewares
      - traefik.http.routers.yojob-survey.middlewares=yojob-survey-headers@docker

      # Réseau Docker
      - traefik.docker.network=yojob-network

    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ==========================================
  # Watchtower - Auto-update (optionnel)
  # ==========================================
  watchtower:
    image: containrrr/watchtower:latest
    container_name: yojob-watchtower
    restart: always
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - WATCHTOWER_CLEANUP=true
      - WATCHTOWER_POLL_INTERVAL=300
      - WATCHTOWER_INCLUDE_STOPPED=false
      - WATCHTOWER_REVIVE_STOPPED=false
      - TZ=Europe/Paris
    networks: [yojob-network]

volumes:
  traefik_data:
    driver: local

networks:
  yojob-network:
    driver: bridge
