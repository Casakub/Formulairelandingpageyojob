# ==========================================
# Docker Compose pour Hostinger - YOJOB
# ==========================================
# Déploie 2 applications React + Traefik avec SSL automatique
#
# Services:
#   - traefik: Reverse proxy avec Let's Encrypt SSL
#   - yojob-landing: Page d'accueil (yojob.fr)
#   - yojob-survey: Formulaire d'étude (etude.yojob.fr)
# ==========================================

services:
  # ==========================================
  # Traefik - Reverse Proxy avec SSL
  # ==========================================
  traefik:
    image: traefik:v3.6.1
    container_name: yojob-traefik
    restart: unless-stopped

    command:
      # API et Dashboard (désactivés en production pour sécurité)
      - "--api.dashboard=false"

      # Provider Docker
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"

      # Entrypoints HTTP et HTTPS
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"

      # Redirection HTTP → HTTPS
      - "--entrypoints.web.http.redirections.entrypoint.to=websecure"
      - "--entrypoints.web.http.redirections.entrypoint.scheme=https"

      # Certificats SSL Let's Encrypt avec TLS Challenge
      - "--certificatesresolvers.mytlschallenge.acme.tlschallenge=true"
      - "--certificatesresolvers.mytlschallenge.acme.email=${SSL_EMAIL}"
      - "--certificatesresolvers.mytlschallenge.acme.storage=/letsencrypt/acme.json"

    ports:
      - "80:80"
      - "443:443"

    volumes:
      # Socket Docker pour découverte automatique des containers
      - /var/run/docker.sock:/var/run/docker.sock:ro
      # Volume persistant pour les certificats SSL
      - letsencrypt:/letsencrypt

    networks:
      - yojob-network

    healthcheck:
      test: ["CMD", "traefik", "healthcheck", "--ping"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s

  # ==========================================
  # Landing Page - Page d'accueil YOJOB
  # ==========================================
  yojob-landing:
    build:
      # Build depuis le repo GitHub (landing page) - branche main
      context: https://github.com/Casakub/Newlandingpageyojob.git#main
      dockerfile: Dockerfile

    container_name: yojob-landing
    restart: unless-stopped

    # Variables d'environnement
    environment:
      - NODE_ENV=production

    # Labels Traefik
    labels:
      - "traefik.enable=true"

      # Router HTTP (redirigé vers HTTPS automatiquement)
      - "traefik.http.routers.yojob-landing.rule=Host(`${DOMAIN_NAME}`) || Host(`www.${DOMAIN_NAME}`)"
      - "traefik.http.routers.yojob-landing.entrypoints=web"

      # Router HTTPS avec SSL
      - "traefik.http.routers.yojob-landing-secure.rule=Host(`${DOMAIN_NAME}`) || Host(`www.${DOMAIN_NAME}`)"
      - "traefik.http.routers.yojob-landing-secure.entrypoints=websecure"
      - "traefik.http.routers.yojob-landing-secure.tls=true"
      - "traefik.http.routers.yojob-landing-secure.tls.certresolver=mytlschallenge"

      # Middleware: redirection www → non-www
      - "traefik.http.middlewares.yojob-landing-redirect-www.redirectregex.regex=^https://www\\.(.+)"
      - "traefik.http.middlewares.yojob-landing-redirect-www.redirectregex.replacement=https://$${1}"
      - "traefik.http.middlewares.yojob-landing-redirect-www.redirectregex.permanent=true"
      - "traefik.http.routers.yojob-landing-secure.middlewares=yojob-landing-redirect-www"

      # Service
      - "traefik.http.services.yojob-landing.loadbalancer.server.port=80"

    networks:
      - yojob-network

    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s

  # ==========================================
  # Survey Form - Formulaire d'étude de marché
  # ==========================================
  yojob-survey:
    build:
      # Build depuis le repo GitHub (survey form) sur une branche spécifique
      context: https://github.com/Casakub/Formulairelandingpageyojob.git#claude/form-website-integration-01TWk7DpCUHeuhHuv1tpg7VJ
      dockerfile: Dockerfile
      args:
        # Variables Supabase injectées au build time (Vite)
        - VITE_SUPABASE_PROJECT_ID=${SUPABASE_PROJECT_ID}
        - VITE_SUPABASE_ANON_KEY=${SUPABASE_ANON_KEY}

    container_name: yojob-survey
    restart: unless-stopped

    # Variables d'environnement
    environment:
      - NODE_ENV=production

    # Labels Traefik
    labels:
      - "traefik.enable=true"

      # Router HTTP (redirigé vers HTTPS automatiquement)
      - "traefik.http.routers.yojob-survey.rule=Host(`etude.${DOMAIN_NAME}`)"
      - "traefik.http.routers.yojob-survey.entrypoints=web"

      # Router HTTPS avec SSL
      - "traefik.http.routers.yojob-survey-secure.rule=Host(`etude.${DOMAIN_NAME}`)"
      - "traefik.http.routers.yojob-survey-secure.entrypoints=websecure"
      - "traefik.http.routers.yojob-survey-secure.tls=true"
      - "traefik.http.routers.yojob-survey-secure.tls.certresolver=mytlschallenge"

      # Service
      - "traefik.http.services.yojob-survey.loadbalancer.server.port=80"

    networks:
      - yojob-network

    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s

# ==========================================
# Networks
# ==========================================
networks:
  yojob-network:
    driver: bridge

# ==========================================
# Volumes
# ==========================================
volumes:
  # Volume persistant pour les certificats SSL Let's Encrypt
  letsencrypt:
    driver: local
