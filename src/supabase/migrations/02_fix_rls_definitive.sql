-- â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
-- â•‘  ğŸ”§ FIX DÃ‰FINITIF ERREUR RLS - YOJOB MARKET RESEARCH         â•‘
-- â•‘  Migration: 02_fix_rls_definitive.sql                        â•‘
-- â•‘  Date: 2025-11-29                                             â•‘
-- â•‘  Temps estimÃ©: 1 minute                                       â•‘
-- â•‘                                                               â•‘
-- â•‘  INSTRUCTIONS:                                                â•‘
-- â•‘  1. Aller sur https://supabase.com/dashboard                  â•‘
-- â•‘  2. Projet: vhpbmckgxtdyxdwhmdxy                             â•‘
-- â•‘  3. SQL Editor â†’ New Query                                   â•‘
-- â•‘  4. Copier-coller TOUT ce fichier                            â•‘
-- â•‘  5. Cliquer sur RUN (ou Ctrl+Enter)                          â•‘
-- â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- Ã‰TAPE 1 : DÃ©sactiver temporairement RLS (pour nettoyage)
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ALTER TABLE market_research_responses DISABLE ROW LEVEL SECURITY;

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- Ã‰TAPE 2 : Supprimer toutes les anciennes policies dÃ©fectueuses
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
DROP POLICY IF EXISTS "allow_public_inserts" ON market_research_responses;
DROP POLICY IF EXISTS "allow_authenticated_reads" ON market_research_responses;
DROP POLICY IF EXISTS "allow_authenticated_updates" ON market_research_responses;
DROP POLICY IF EXISTS "allow_authenticated_deletes" ON market_research_responses;

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- Ã‰TAPE 3 : Donner les permissions GRANT nÃ©cessaires
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

-- Autoriser les utilisateurs anonymes (formulaire public) Ã  INSERT
GRANT INSERT ON market_research_responses TO anon;

-- Autoriser les utilisateurs authentifiÃ©s (dashboard admin) Ã  tout faire
GRANT SELECT, INSERT, UPDATE, DELETE ON market_research_responses TO authenticated;

-- Le service_role (Supabase backend) a dÃ©jÃ  tous les droits, mais on s'assure
GRANT ALL ON market_research_responses TO service_role;

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- Ã‰TAPE 4 : RecrÃ©er les policies avec la syntaxe correcte
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
-- Policy 1: Permettre Ã  TOUS d'insÃ©rer (formulaire public)
-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
-- âš ï¸ CHANGEMENT CLÃ‰: Utiliser "public" au lieu de "anon, authenticated"
-- En PostgreSQL/Supabase, "public" = TOUS les rÃ´les (anon + authenticated)
-- C'est plus robuste et standard que la syntaxe "TO anon, authenticated"

CREATE POLICY "allow_public_inserts"
  ON market_research_responses
  FOR INSERT
  TO public  -- âœ… "public" = anon + authenticated + tous les autres rÃ´les
  WITH CHECK (true);  -- Aucune restriction sur l'insertion

-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
-- Policy 2: Permettre aux users authentifiÃ©s de lire (dashboard)
-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
CREATE POLICY "allow_authenticated_reads"
  ON market_research_responses
  FOR SELECT
  TO authenticated
  USING (true);  -- Peut lire toutes les lignes

-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
-- Policy 3: Permettre aux users authentifiÃ©s de mettre Ã  jour
-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
CREATE POLICY "allow_authenticated_updates"
  ON market_research_responses
  FOR UPDATE
  TO authenticated
  USING (true)  -- Peut modifier toutes les lignes
  WITH CHECK (true);  -- Aucune restriction sur les nouvelles valeurs

-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
-- Policy 4: Permettre aux users authentifiÃ©s de supprimer
-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
CREATE POLICY "allow_authenticated_deletes"
  ON market_research_responses
  FOR DELETE
  TO authenticated
  USING (true);  -- Peut supprimer toutes les lignes

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- Ã‰TAPE 5 : RÃ©activer RLS
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ALTER TABLE market_research_responses ENABLE ROW LEVEL SECURITY;

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- Ã‰TAPE 6 : VÃ©rification automatique (affichage des policies)
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
SELECT 
  schemaname,
  tablename,
  policyname,
  permissive,
  roles,
  cmd,
  qual,
  with_check
FROM pg_policies
WHERE tablename = 'market_research_responses'
ORDER BY policyname;

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- âœ… RÃ‰SULTAT ATTENDU DANS LES RESULTS
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- Vous devriez voir exactement 4 policies :
--
-- â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”
-- â”‚ policyname                   â”‚ roles           â”‚ cmd    â”‚
-- â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¤
-- â”‚ allow_authenticated_deletes  â”‚ {authenticated} â”‚ DELETE â”‚
-- â”‚ allow_authenticated_reads    â”‚ {authenticated} â”‚ SELECT â”‚
-- â”‚ allow_authenticated_updates  â”‚ {authenticated} â”‚ UPDATE â”‚
-- â”‚ allow_public_inserts         â”‚ {public}        â”‚ INSERT â”‚ âš ï¸ IMPORTANT
-- â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜
--
-- âš ï¸ LA LIGNE CRITIQUE: "allow_public_inserts" avec roles = {public}
--
-- Si vous voyez {public} dans la colonne "roles" â†’ âœ… C'EST BON !
-- Si vous voyez {anon,authenticated} â†’ âŒ La syntaxe n'a pas marchÃ©
--
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- ğŸ“Š VÃ‰RIFICATIONS SUPPLÃ‰MENTAIRES (optionnel)
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

-- VÃ©rifier que RLS est bien activÃ©
SELECT 
  schemaname,
  tablename, 
  rowsecurity as "RLS activÃ©"
FROM pg_tables 
WHERE tablename = 'market_research_responses';
-- Attendu: RLS activÃ© = true

-- VÃ©rifier les permissions GRANT
SELECT 
  grantee as "RÃ´le", 
  string_agg(privilege_type, ', ' ORDER BY privilege_type) as "Permissions"
FROM information_schema.role_table_grants 
WHERE table_name = 'market_research_responses'
  AND grantee IN ('anon', 'authenticated', 'service_role')
GROUP BY grantee
ORDER BY grantee;
-- Attendu:
--   anon          â†’ INSERT
--   authenticated â†’ DELETE, INSERT, SELECT, UPDATE
--   service_role  â†’ DELETE, INSERT, REFERENCES, SELECT, TRIGGER, TRUNCATE, UPDATE

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- ğŸ§ª TEST D'INSERTION (optionnel - dÃ©commenter pour tester)
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- DÃ©commentez les lignes ci-dessous pour tester une insertion directe
-- Si Ã§a fonctionne, votre formulaire fonctionnera aussi !

/*
INSERT INTO market_research_responses (
  response_id, 
  q1_nom, 
  q2_annee, 
  q3_taille, 
  q4_secteurs,
  q5_pays,
  q6_volume,
  q7_origine,
  q8_destinations,
  q9_defi,
  q9_autre,
  q10_gestion,
  q11_incidents,
  q12_budget,
  q13_manque_gagner,
  q14_risques,
  q15_probleme,
  q16_erp,
  q16_autre,
  q17_migration,
  q18_score,
  q19_features,
  q20_prix,
  q21_budget_mensuel,
  q22_mvp,
  q23_role,
  q24_evolution,
  q25_besoins,
  email,
  autorise_contact,
  souhaite_rapport
) VALUES (
  'TEST-' || floor(random() * 1000000)::text,
  'Test Agency SQL Migration',
  '2010',
  '10-50 salariÃ©s',
  ARRAY['BTP', 'Industrie'],
  'France',
  '50-100 par an',
  'France, Allemagne',
  'Espagne, Portugal',
  'ConformitÃ© lÃ©gale',
  '',
  'Manuel (Excel/Word)',
  'Oui, occasionnellement',
  '5 000 - 10 000 â‚¬',
  '10 000 - 20 000 â‚¬',
  'ConformitÃ©',
  'Gestion multi-pays complexe',
  'Autre',
  'Custom ERP',
  'PrÃªt Ã  migrer maintenant',
  9,
  ARRAY['Gestion multi-pays', 'Automatisation documents'],
  'Abonnement mensuel/annuel',
  '500 - 1 000 â‚¬',
  'Oui, absolument',
  'Dirigeant/GÃ©rant',
  'Expansion vers nouveaux pays',
  'Automatisation complÃ¨te des processus',
  'test.migration@yojob.fr',
  true,
  true
) RETURNING response_id, q1_nom, email, created_at;

-- Si vous voyez le rÃ©sultat avec le response_id â†’ âœ… SUCCÃˆS !
*/

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- ğŸ“ NOTES TECHNIQUES
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- 
-- Pourquoi "TO public" au lieu de "TO anon, authenticated" ?
-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
-- En PostgreSQL, le rÃ´le "public" est un rÃ´le spÃ©cial qui reprÃ©sente
-- TOUS les utilisateurs. C'est l'Ã©quivalent de "tout le monde".
-- 
-- Dans Supabase:
--   - "anon" = utilisateurs non authentifiÃ©s (formulaire public)
--   - "authenticated" = utilisateurs authentifiÃ©s (dashboard admin)
--   - "public" = anon + authenticated + tous les autres rÃ´les
-- 
-- La syntaxe "TO anon, authenticated" peut causer des problÃ¨mes
-- avec certaines versions de PostgreSQL ou configurations RLS.
-- "TO public" est plus standard et robuste.
-- 
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- ğŸ¯ APRÃˆS CE FIX
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- 
-- âœ… Le formulaire public pourra soumettre (rÃ´le "anon")
-- âœ… Le dashboard admin pourra lire/modifier/supprimer (rÃ´le "authenticated")
-- âœ… Plus d'erreur "42501 - row-level security policy"
-- 
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
